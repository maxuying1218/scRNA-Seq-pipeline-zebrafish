## 1.Read files
```
library(Seurat)
library(dplyr)
library(SingleCellExperiment)
library(tidyverse)
library(reshape2)
library(ggplot2)
library(monocle)

WT_raw_count<-Read10X(data.dir = "WT_3d/")
WT <- CreateSeuratObject(counts = WT_raw_count,min.features = 100)
coronacytosis_raw_count<-Read10X(data.dir = "Coronacytosis_3d/")
coronacytosis <- CreateSeuratObject(counts = coronacytosis_raw_count, min.features = 100)
WT$sample<-"WT"
coronacytosis$sample<-"coronacytosis"
```
## Normalize and merge samples
```
## add all samples to a list and normalize samples
name_list <- c(WT,coronacytosis)
name_list <- lapply(X = name_list, FUN = function(x) {
          x <- subset(x,subset=nFeature_RNA>300)
      x <- NormalizeData(x)
      x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
  })

## find anchors among samples
features <- SelectIntegrationFeatures(object.list = name_list)
zf.anchors <- FindIntegrationAnchors(object.list = name_list, anchor.features = features)

## merge and scale samples
zf.combined <- IntegrateData(anchorset = zf.anchors)
DefaultAssay(zf.combined)<-"integrated"
df <-ScaleData(zf.combined)
### save scaled data as a backup
saveRDS(integ.combined,"df_all_sample.scaled.rds")
```
## Run PCA & UMAP
```
df <-RunPCA(object =df)
df <- RunHarmony(df,group.by.vars="sample",max.iter.harmony =6,project.dim = F)
df <- RunUMAP(object =df,reduction = "harmony",dims = 1:20)
```
## Cluster & identify macrophages
```
df <- FindNeighbors(df,reduction = "pca", dims = 1:20)
df <- FindClusters(df, resolution = 0.3)

p1<-DimPlot(df, reduction = "umap",label=TRUE)
p2 <- FeaturePlot(df, features = c("mpeg1.1","mfap4"), min.cutoff = "q9",label = TRUE,ncol=2,cols=c("grey","red"))
p3 <- p1|p2
p3
```
